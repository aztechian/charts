name: Helm Chart linting

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master
    tags:
      - v*

# This ensures that previous jobs for the PR are canceled when the PR is
# updated.
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  helm-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run helm lint
        run: |
          for c in $(find . -name Chart.yaml); do
            helm lint $(basename ${c%%/Chart.yaml})
          done;
  helm-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install helm-docs
        run: |
          hd_ver=$(grep '^helm-docs' .tool-versions| cut -f2 -d ' ')
          echo "::info::helm-docs version = ${hd_ver}"
          cd /tmp
          curl -sL "https://github.com/norwoodj/helm-docs/releases/download/v${hd_ver}/helm-docs_${hd_ver}_Linux_x86_64.tar.gz" | tar xzf - && \
          chmod +x ./helm-docs
          mv ./helm-docs /usr/local/bin/

      - name: Run helm-docs
        run: |
          helm-docs

      - name: Test for changes
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add .
          mods=$(git diff --name-only --cached)
          if [[ -z $mods ]]; then
            exit 0
          else
            echo "::debug::$(git diff --cached)"
            for f in ${mods}; do
              echo "::warning file=${f},title=${f}::file would be updated by helm-docs"
            done
